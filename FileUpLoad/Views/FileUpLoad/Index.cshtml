
@{
    ViewBag.Title = "文件上传Demo";
}
<style>
    div.form-item {
        margin-top: 20px;
    }

    form {
        border: 2px solid green;
        margin: 5px;
    }
</style>

<form action="../FileUpLoad/ReciveFile2" method="post" enctype="multipart/form-data">
    <div class="form-item">
        <label for="Param1">自定义参数</label>
        <input type="text" name="Param1" required placeholder="第一个传入参数" value="参数一" />
    </div>
    <div class="form-item">
        <label for="file1">文件1</label>
        <input type="file" name="file1" />
    </div>
    <div class="form-item">
        <label for="file2">文件2</label>
        <input type="file" name="file2" />
    </div>
    <div class="form-item">
        <input type="submit" value="提交" />
    </div>
</form>

<form action="../FileUpLoad/ReciveFile3" method="post" enctype="multipart/form-data">
    <div class="form-item">
        <label for="Param1">自定义参数</label>
        <input type="text" name="Param1" required placeholder="第一个传入参数" value="参数一" />
    </div>
    <div class="form-item">
        <label for="file1">文件1</label>
        <input type="file" name="file1" maxFilesSize= "1024*1024*20" required="required" />
    </div>
    <div class="form-item">
        <label for="file2">文件2</label>
        <input type="file" name="file2" maxFilesSize= "1024*1024*1024"  />
    </div>
    <div class="form-item">
        <input type="button" value="提交" onclick="ajaxCommit(this)" />
    </div>
</form>
<form action="../FileUpLoad/ReciveFile2" method="post" enctype="multipart/form-data">
    <div class="form-item">
        <label for="Param1">自定义参数</label>
        <input type="text" name="Param1" required placeholder="第一个传入参数" value="参数一" />
    </div>
    <div class="form-item">
        <label for="file1">文件1</label>
        <input type="file" name="file1" maxFilesSize="1024*1024*20" required="required" />
    </div>
    @*<div class="form-item">
        <label for="file2">文件2</label>
        <input type="file" name="file2" maxFilesSize="1024*1024*1024" />
    </div>*@
    <div class="form-item">
        <input type="button" value="提交" onclick="ajaxCommit1(this)" />
    </div>
</form>
<form action="../FileUpLoad/ReciveFile4" method="post" enctype="multipart/form-data">
    <div class="form-item">
        <label for="Param1">自定义参数</label>
        <input type="text" name="Param1" required placeholder="第一个传入参数" value="参数一" />
    </div>
    <div class="form-item">
        <label for="file1">文件1</label>
        <input type="file" name="file1" maxFilesSize="1024*1024*1024" required="required" multiple />
    </div>
    <div class="form-item">
            <label for="file2">文件2</label>
            <input type="file" name="file2" maxFilesSize="1024*1024*1024"  multiple />
    </div>
    <div class="form-item">
        <input type="button" value="提交" onclick="ajaxCommit3(this)" />
    </div>
</form>
<div  class="progress-group"  style="border:2px solid blue">
    <div class="progress-total">
        <h4>总进度</h4>
        <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="60"
                 aria-valuemin="0" aria-valuemax="100" style="width: 40%;">
                <span class="sr-only">40% 完成</span>
            </div>
        </div>
        <button class="pause glyphicon glyphicon-pause"></button>
        <button class="play glyphicon glyphicon-play" ></button>
    </div>
</div>

@section scripts{
    <script src="~/Scripts/jquery.nemo.ajaxform.js"></script>
    <script type="text/javascript">


        function FileHandler(opt) {
            this.InputFileName = opt.inputFileName;                                         // input file name 属性
            this.file = opt.file;                                                           //上传文件
            this.fileName = this.file.name;                                                  // 文件名称
            this.totalSize = this.file.size;                                                 //文件大小
            this.blockTotal = Math.ceil(this.totalSize / this.blockSize);                   //数据块总数
            this.upLoadId = null;                                                           //上传数据块唯一标示
            this.blockIndex = 1;                                                            //上传块索引
            this.PauseStatus = false;                                                             //暂停状态
            this.Progress = new ProgressHandler(this);             //创建进度条

            this.Pause = () => {
                console.log(this.PauseStatus);
                this.PauseStatus = true;
            };
            this.Continue = () => {
                if (this.PauseStatus) {
                    this.PauseStatus = false;
                    this.Send(this);
                }
            };


            //上传状态
            this.sendStatus = 0;                                                            // 0表示上传中；-1 表示中断；1上传完成
            this.FormFileInfo = {}                                                          //构建上传文件信息
            this.FormFileInfo.UpLoadId = '';
            this.FormFileInfo.BlockTotal = this.blockTotal;
            this.FormFileInfo.BlockIndex = this.blockIndex;
            this.FormFileInfo.FileName = this.fileName;
            this.formData = new FormData();                          //创建表单
            this.formData.append("FileInfo", JSON.stringify(this.FormFileInfo));
            this.formData.append("HandleStatus", "FILESAVE");            //告诉后台文件保存
            this.formData.append(this.InputFileName, null);
        }
        FileHandler.prototype.blockSize = 1024 * 1024 * 3; //设置每次上传块的大小
        FileHandler.prototype.Send = function (that) {
            console.log(that.PauseStatus);
            if (that.PauseStatus) {
                //暂停
                return false;
            }
            that.sendStatus = 0;  //表示传送中
            var start = (that.blockIndex - 1) * that.blockSize;
            var end = Math.min(that.totalSize, start + that.blockSize);
            that.formData.set(that.InputFileName, that.file.slice(start, end));
            that.FormFileInfo.UpLoadId = that.upLoadId;
            that.FormFileInfo.BlockIndex = that.blockIndex;
            that.formData.set("FileInfo", JSON.stringify(that.FormFileInfo));
            $.ajax({
                url: "../FileUpLoad/ReciveFile4",
                method: 'POST',
                data: that.formData,
                contentType: false,
                processData: false,
                dataType: 'json',
                success: function (reData) {
                    if (reData.BlockSaveStatus) {
                        that.blockIndex++;
                        if (that.blockIndex == 2) {
                            that.upLoadId = reData.UpLoadId;
                        }
                        if (that.blockIndex <= that.blockTotal) {
                            that.Send(that);
                        }
                        else {
                            that.sendStatus = 1;
                            console.log("上传成功！");
                        }
                    }else {
                        //终止上传
                        that.sendStatus = -1;
                    }
                },
                error: function (e) {
                    //终止上传
                    that.sendStatus = -1;
                },
                complete: function () {
                    //if (typeof (progress) == "function")
                    //    progress(that);
                    that.Progress(that);
                }
            });
        }




        //暂停文件上传
        //FileHandler.prototype.Pause = () => {
        //    console.log(this.PauseStatus);
        //    this.PauseStatus = true;
        //}
        //继续上传文件
        //FileHandler.prototype.Continue = () => {
        //    if (this.PauseStatus) {
        //        this.PauseStatus = false;
        //        this.Send(this);
        //    }
        //}


        //进度条类//可以定制
        //文件名称
        function ProgressHandler(opt) {
            var progress = $("div.progress-total").clone();
            progress.removeClass("progress-total");
            progress.find("h4").text(opt.fileName);
            $("div.progress-group").append(progress);
            progress.find("button.pause").click(function () {
                opt.Pause();
            });
            progress.find("button.play").click(function () {
                opt.Continue();
            })
            return (status) => {
                console.log(status.blockIndex);
                progress.find(".progress-bar")
                    .css("width", Math.ceil((status.blockIndex <= status.blockTotal ? (status.blockIndex - 1) * status.blockSize : status.totalSize) * 100 / status.totalSize) + "%");
            }
        }




        function ajaxUploadFile(opt, funProgress) {
            var blockSize = 1024 * 1024 * 3;                    //块大小
            var dataBlock = opt.fileInputName;                  //input file name 属性
            var file = opt.file;                                //上传文件
            var fileName = file.name;                           // 文件名称          
            var totalSize = file.size;                          //文件大小
            var blockTotal = Math.ceil(totalSize / blockSize);  //数据块总数
            var upLoadId = null;                                //上传数据块唯一标示
            var blockIndex = 1;                                 //上传块索引
            //进度信息
            var progressInfo = { };
            progressInfo.Key = dataBlock;
            progressInfo.FileName = fileName;
            progressInfo.TotalSize = totalSize;
            progressInfo.FinisheSize = 0;
            progressInfo.Finished = false;
            progressInfo.UpLoadId = null;
            progressInfo.Status = true;  //上传状态
            progressInfo.ErrTimes = 0;   //上传错误次数
            progressInfo.BlockSize = blockSize;

            var FormFileInfo = {} //构建上传文件信息

            FormFileInfo.UpLoadId = '';
            FormFileInfo.BlockTotal = blockTotal;
            FormFileInfo.BlockIndex = blockIndex;
            FormFileInfo.FileName = fileName;
            var formData = new FormData();
            formData.append("FileInfo", JSON.stringify(FormFileInfo));
            formData.append("HandleStatus", "FILESAVE");
            formData.append(dataBlock, null);
            (function upLoad() {
                var start = (blockIndex - 1) * blockSize;
                var end = Math.min(totalSize, start + blockSize);
                formData.set(dataBlock, file.slice(start, end));
                FormFileInfo.UpLoadId = upLoadId;
                FormFileInfo.BlockIndex = blockIndex;
                formData.set("FileInfo", JSON.stringify(FormFileInfo));
                $.ajax({
                    url: "../FileUpLoad/ReciveFile4",
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    success: function (reData) {
                        console.log(reData.BlockIndex);
                        if (reData.BlockSaveStatus) {
                            progressInfo.Status = true;
                            progressInfo.FinisheSize += blockSize;
                            progressInfo.BlockSize = progressInfo.FinisheSize > totalSize ? (blockSize - (progressInfo.FinisheSize - totalSize)) : blockSize;
                            progressInfo.FinisheSize = progressInfo.FinisheSize > totalSize ? totalSize : progressInfo.FinisheSize;                            
                            blockIndex++;
                            if (blockIndex == 2) {
                                upLoadId = reData.UpLoadId;
                                progressInfo.UpLoadId = upLoadId;
                            }
                            if (blockIndex <= blockTotal) {
                                funProgress(progressInfo);
                                upLoad();
                            }
                            else {
                                console.log("上传成功！");
                                progressInfo.Finished = true;
                                funProgress(progressInfo);
                            }
                        } else if (progressInfo.ErrTimes <= 10) {
                            //错误上传次数小于10次继续上传
                            progressInfo.ErrTimes += 1;
                            progressInfo.Status = false;
                            funProgress(progressInfo);
                            upLoad();
                        } else {
                            //终止上传
                            progressInfo.ErrTimes += 1;
                            progressInfo.Status = false;
                            funProgress(progressInfo);
                        }
                        
                    },
                    error: function (e) {
                        console.log(e);
                    }
                })
            })();
        }

        //function ajaxUploadFile(opt) {
        //    var dataBlock = opt.fileInputName;                  //input file name 属性
        //    var file = opt.file;                                //上传文件名
        //    var blockSize = 1024 * 1024 * 3;                    //块大小
        //    var totalSize = file.size;                          //文件大小
        //    var blockTotal = Math.ceil(totalSize / blockSize);  //数据块总数
        //    var upLoadId = null;                                //上传数据块唯一标示
        //    var blockIndex = 0;                                 //上传块索引
        //    var formData = new FormData();
        //    formData.append('FileName', file.name);
        //    formData.append('BlockTotal', blockTotal);
        //    formData.append('BlockIndex', blockIndex);
        //    formData.append('UpLoadId', '');
        //    formData.append(dataBlock, null);
        //    (function upLoad() {
        //        blockIndex++;
        //        var start = (blockIndex - 1) * blockSize;
        //        var end = Math.min(totalSize, start + blockSize);
        //        formData.set(dataBlock, file.slice(start, end));
        //        formData.set('BlockIndex', blockIndex);
        //        formData.set('UpLoadId', upLoadId);
        //        $.ajax({
        //            url: "../FileUpLoad/ReciveFile4",
        //            method: 'POST',
        //            data: formData,
        //            contentType: false,
        //            processData: false,
        //            dataType: 'json',
        //            success: function (reData) {
        //                if (blockIndex == 1)
        //                    upLoadId = reData.UpLoadId;
        //                if (blockIndex < blockTotal) {
        //                    upLoad();
        //                }
        //                else {
        //                    console.log("上传成功！");
        //                }
        //            },
        //            error: function (e) {
        //                console.log(e);
        //            }
        //        })
        //    })();
        //}


        function ajaxCommit3(opt) {
            var $form = $(opt).parents("form");
            var $fileInput = $form.find("input[type=file]");

            var filesStatus = {};
            filesStatus.fileHandlers = [];
            filesStatus.TotalFileCnt = 0;
            filesStatus.FinishedFileCnt = 0;
            filesStatus.TotalSize = 0;
            filesStatus.FinishedSize = 0;
            $fileInput.each(function () {
                $(this.files).each(function () {
                    filesStatus.TotalFileCnt += 1;
                    filesStatus.TotalSize += this.size;
                });
            });

            $fileInput.each(function () {
                var inputFileName = this.name;
                $(this.files).each(function () {
                    var that = this;
                    var handler = new FileHandler({ file: that, inputFileName: inputFileName });
                    filesStatus.fileHandlers.push(handler);
                    handler.Send(handler, function (that) {
                        switch (that.sendStatus) {
                            case 0:
                                //传输中
                                filesStatus.FinishedSize += that.blockSize;
                                break;
                            case 1:
                                //完成传输
                                filesStatus.FinishedSize += that.totalSize % that.blockSize;
                                filesStatus.FinishedFileCnt += 1;
                                break;
                            case -1:
                                break;
                        }
                        console.log(that.fileName + "完成进度:" + Math.ceil((that.blockIndex <= that.blockTotal ? (that.blockIndex - 1) * that.blockSize : that.totalSize)    * 100 / that.totalSize));
                        console.log("总进度：" + filesStatus.FinishedSize + "/" + filesStatus.TotalSize + ";" + filesStatus.FinishedFileCnt + "/" + filesStatus.TotalFileCnt);
                    });
                });
            });


            
        }



        function ajaxCommit2(opt) {
            var $form = $(opt).parents("form");
            var $fileInput = $form.find("input[type=file]");
            $fileInput.each(function () {
                var file = this.files[0];
                var blockSize = 1024 * 1024 * 3;//块大小
                var totalSize = file.size;
                var blockCnt = Math.ceil(totalSize / blockSize);
                var upLoadId = null;
                var index = 0;
                var formData = new FormData();
                formData.append('FileSaveName', file.name);
                formData.append('BlockTotal', blockCnt);
                formData.append('BlockIndex', index);
                formData.append('UpLoadId', null);
                formData.append('DataBlock', null);
                (function upload() {
                    index++;
                    var start = (index - 1) * blockSize;
                    var end = Math.min(totalSize, start + blockSize);
                    formData.set('DataBlock', file.slice(start, end));
                    formData.set('BlockIndex', index);
                    formData.set('UpLoadId', upLoadId);
                    $.ajax({
                        url: "../FileUpLoad/ReciveFile4",
                        method: 'post',
                        data: formData,
                        contentType: false,
                        processData: false,
                        dataType: 'json',
                        success: function (reData) {
                            console.log(reData);
                            if (index == 1)
                                upLoadId = reData.UpLoadId;
                            if (index < blockCnt) {
                                upload();
                            }
                            else {
                                console.log("上传成功！");
                            }
                        },
                        error: function (e) {
                            console.log(e);
                        }
                    })
                })()

            })


        }





        function ajaxCommit1(opt) {
            var $form = $(opt).parents("form");
            var $fileInput = $form.find("input[type=file]");
            $fileInput.each(function () {
                var file = this.files[0];
                var blockSize = 1024 * 1024 * 2;//块大小
                var totalSize = file.size;
                var blockCnt = Math.ceil(totalSize / blockSize);
                var upLoadId = null;
                var index = 0;
                var formData = new FormData();
                formData.append('FileName', file.name);
                formData.append('TotalBlock', blockCnt);
                formData.append('Index', index);
                formData.append('UpLoadId', null);
                formData.append('DataBlock', null);
                alert(blockCnt);
                (function upload() {
                    index++;
                    var start = (index - 1) * blockSize;
                    var end = Math.min(totalSize, start + blockSize);
                    formData.set('DataBlock', file.slice(start, end));
                    formData.set('Index', index);
                    formData.set('UpLoadId', upLoadId);
                    $.ajax({
                        url: "../FileUpLoad/ReciveFile3",
                        method: 'post',
                        data: formData,
                        contentType: false,
                        processData: false,
                        dataType:'json',
                        success: function (reData) {
                            console.log(reData);
                            if (index == 1)
                                upLoadId = reData.UpLoadId;
                            if (index < blockCnt) {
                                upload();
                            }
                            else {
                                console.log("上传成功！");
                            }
                        },
                        error: function (e) {
                            console.log(e);
                        }
                    })
                })()
                
            })


        }


        function ajaxCommit(opt) {
            $form = $(opt).parents("form");
            var $files = $form.find("input[type=file]");
            alert($files.length);
            //$files.each(function () {
            //    var $this = $(this);
            //    alert($this.attr("required"));
            //    if (this.files.length == 0) {
            //        alert("请选择要上传的文件");
            //        return false;
            //    };
            //    var file = this.files[0];
            //    //上传文件扩展名限制【当用户换一个扩展名还是可以上传Bug】
            //    var accept = $(this).attr("accept");
            //    accept = accept == undefined ? "*" : accept.toLowerCase(); //"*" 表示类型无限制
            //    var fileName = file.name;
            //    var fileExtension = $.trim(fileName.substring(fileName.lastIndexOf(".")).toLowerCase());
            //    if (accept != "*" && accept.indexOf(fileExtension) == -1) {
            //        alert("上传文件 【" + file.name + "】 类型不符合要求【" + accept + "】");
            //        return false;
            //    }
            //    //上传问价大小限制
            //    var maxFileSize = $this.attr("maxFilesSize");  //用户配置大小
            //    maxFileSize = maxFileSize == undefined ? 0 : eval(maxFileSize); //0表示文件大小无限制
            //    if (maxFileSize != 0 && file.size > maxFileSize) {
            //        alert("上传文件 【" + file.name + "】 大小超出限制【 " + (maxFileSize / 1024 / 1024) + "M】 ");
            //        return false;
            //    }
            //});

            //return false;
            //var formData = new FormData($this.parents("form")[0]);
            $.fn.nemoAjaxForm({
                url: "../FileUpLoad/ReciveFile2",
                method: "POST",
                form: $form,
                contentType: false,
                processData: false,//避免对formData序列化处理
                dataType: "text",
                success: function (reData) {
                    alert(reData);
                },
                error: function (reData) {
                    console.log(reData);
                }
            })

        }


    </script>
    }